<!DOCTYPE html>
<html data-n-head-ssr data-n-head="">
  <head>
    <meta data-n-head="true" charset="utf-8"/><meta data-n-head="true" name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/><meta data-n-head="true" name="description" content="文蔺的前端学习记录，国外技术文章翻译，个人学习心得等等这些都会记录在这里。"/><meta data-n-head="true" name="keywords" content="JavaScript,开发心得,原创"/><meta data-n-head="true" name="description" content="笔记：如何获取网站根域名"/><title data-n-head="true">笔记：如何获取网站根域名 | 文蔺的博客</title><link data-n-head="true" rel="favicon" href="/favicon.ico"/><link rel="stylesheet" href="/static/common.5ad111a3.css"><style data-vue-ssr-id="645210e9:0">#__layout,#__nuxt,.wrapper{width:100%;height:100%}.main{height:100%}.main>article,.main>div,.main>section{min-height:100%;margin-bottom:-81px}.main>article:after,.main>div:after,.main>section:after{display:block;content:"";height:81px}.main>article,.main>div,.main>section{border-bottom:0}.main>#footer{position:relative;z-index:1;border-top:0}</style>
  </head>
  <body data-n-head="">
    <div data-server-rendered="true" id="__nuxt"><div class="nuxt-progress" style="width:0%;height:2px;background-color:black;opacity:0;"></div><div id="__layout"><div class="wrapper"><nav id="sidebar" class="behavior_1"><div class="wrap"><div class="profile"><a href="/" class="nuxt-link-active"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a><span>文蔺的博客</span></div><ul class="buttons"><li><a href="/" title="主页" class="nuxt-link-active"><i class="iconfont icon-home"></i><span> 主页</span></a></li><li><a href="/archives" title="归档"><i class="iconfont icon-archive"></i><span> 归档</span></a></li><li><a href="/tags" title="标签"><i class="iconfont icon-tags"></i><span> 标签</span></a></li><li><a href="/about" title="关于"><i class="iconfont icon-user"></i><span> 关于</span></a></li><li><a href="/link" title="关注"><i class="iconfont icon-link"></i><span> 关注</span></a></li><li><a href="/collection" title="收藏"><i class="iconfont icon-archive"></i><span> 收藏</span></a></li></ul></div><ul class="buttons"><li><a href="https://github.com/AngusFu/" rel="nofollow" target="_blank" class="inline"><i title="GitHub" class="iconfont icon-github-v"></i></a><!----><!----><a href="/atom.xml" target="_blank" class="inline"><i title="RSS" class="iconfont icon-rss-v"></i></a><a href="/search" class="inline"><i title="Search" class="iconfont icon-search"></i></a></li></ul></nav><div id="header"><div class="btn-bar"><i></i></div><h1><a href="/" class="nuxt-link-active">文蔺的博客</a></h1><a href="/about/" class="me"><img src="/imgs/avatar.jpg" alt="文蔺的博客"></a></div><div id="sidebar-mask" style="display:none;"></div><div id="main" class="main"><div id="page-post"><article class="post detail"><div class="meta"><div class="date">2017-04-26</div></div><h1 class="title">笔记：如何获取网站根域名</h1><div class="entry-content"><!----><p>首先声明，这里所说的“根域名”，并不是指“全球共有13台根逻辑域名服务器”这句话中的“根域名”。而是指某一个站点的“根域名”（更新：或者也可以称之为“当前网站的主域名”，目前笔者并没有找到标准称呼）。</p><p>百度搜索是“www.baidu.com”，百度翻译的域名是“fanyi.baidu.com”，百度地图的域名则是“map.baidu.com”。这些域名有共同的部分“baidu.com”。在本文中，我们将“baidu.com”这样的域名称为“根域名”。前端同学应该都知道，在“.baidu.com”这一域下的 cookie 可以在其他子站点下拿到（当然，前提是端口号和协议都保持一致）。</p><p>最近开发的过程中遇上了一个小问题。无论访问哪个子站点，都要通过 js 将 cookie 存放到根域名下。</p><p>一开始比较大意，直接拿正则匹配。问题是忽略了这世界上还存在“www.xxx.edu.cn”这样的站点。在这种情况下，显然我们不能认为”edu.cn“是根域名。想在一个叫“edu.cn”的域下存 cookie？对不起，浏览器做不到。（这句话很重要。）</p><p>正则匹配是做不到了。搜索了一下，网上也没有什么特别好的解决方案。无非是枚举出国内常见的一些顶级域名，然后再进行处理，如下面这个 PHP 的例子：</p><p><img alt=""></p><p>但如何确保我们枚举出的例子一定是完全的无遗漏的呢？不完美，放弃。</p><h2 id="psl">PSL</h2><p>接着上 github 上去找例子。倒是发现了一些解决域名的工具。比如一个名为 <a href="https://github.com/wrangr/psl" target="_blank">psl</a> 的仓库。</p><p><a href="http://publicsuffix.org/" target="_blank">PSL</a> 是 “Public Suffix List” 的缩写，这个“公共域名后缀列表”项目本来是供浏览器厂商使用的。可以访问<a href="https://publicsuffix.org/" target="_blank">官网</a>，另外建议看看这篇<a href="https://imququ.com/post/domain-public-suffix-list.html" target="_blank">《域名小知识：Public Suffix List》</a>。</p><p><img alt=""></p><p>我搜索到的这个 psl 仓库正是基于 PSL、使用 js 来解析域名的。粗略看了下，存放域名的 json 文件有 108 KB。吓死了。</p><p><img alt=""></p><p>另一款叫做 <a href="https://github.com/peerigon/parse-domain/" target="_blank">parse-domain</a> 的，光是生成的正则表达式文件就有 203 KB。</p><p><img alt=""></p><p>没办法，一个跑到浏览器上的前端脚本，本身不到 1500 行，为了一个判断引入上百 KB 的外部依赖，实在不划算。</p><p>于是只能自己另起炉灶，想想别的办法。</p><h2 id="document-domain">document.domain</h2><p>首先想到的是 <textarea width="0" height="0" class="codespan" style="display:none;">document.domain</textarea>。在一些需要跨域的场景中，可能会见到这货的身影。比如<a href="http://www.tuicool.com/articles/jmY3Yr6" target="_blank">这篇文章</a> 所描述的，“相同主域名不同子域名下的页面，可以设置 document.domain 让它们同域”。</p><p>经过测试发现，对于域名<textarea width="0" height="0" class="codespan" style="display:none;">c.example.edu.cn</textarea>下的页面，可以执行下面这句：</p><textarea width="0" height="0" class="pre-area" style="display:none;">&lt;code class=&quot;hljs lang-javascript&quot;&gt;%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E'example.edu.cn'%3C%2Fspan%3E%3B&lt;/code&gt;</textarea><p>而在 Chrome 下，下面这句则无法执行：</p><textarea width="0" height="0" class="pre-area" style="display:none;">&lt;code class=&quot;hljs lang-javascript&quot;&gt;%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20DOMException%3C%2Fspan%3E%0A%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E'edu.cn'%3C%2Fspan%3E%3B&lt;/code&gt;</textarea><p>浏览器会抛出<textarea width="0" height="0" class="codespan" style="display:none;">DOMException</textarea>：</p><blockquote><p>1 Uncaught DOMException: Failed to set the 'domain' property on 'Document': 'edu.cn' is not a suffix of 'c.example.edu.cn'.</p></blockquote><p>IE 也会报出“参数无效”的错误；Firefox 下同样会抛出错误：</p><blockquote><p>NS_ERROR_DOM_BAD_DOCUMENT_DOMAIN: Illegal document.domain value</p></blockquote><p>从报错信息可以看到， DOMException 是可以捕获到的。那就好办了。</p><p>将域名（或页面当前的 <textarea width="0" height="0" class="codespan" style="display:none;">document.domain</textarea>） split 成数据 <textarea width="0" height="0" class="codespan" style="display:none;">['x', 'example', 'edu', 'cn']</textarea>，从右向左逐次加上一个元素，每次将单词使用句点连接并赋值给 <textarea width="0" height="0" class="codespan" style="display:none;">document.domain</textarea>。如果 catch 到错误，则进行下一次操作。一旦赋值成功，即可 break 循环。</p><p>上代码：</p><textarea width="0" height="0" class="pre-area" style="display:none;">&lt;code class=&quot;hljs lang-javascript&quot;&gt;%3Cspan%20class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E%20domain%20%3D%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E%20list%20%3D%20domain.split(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%0A%3Cspan%20class%3D%22hljs-keyword%22%3Elet%3C%2Fspan%3E%20len%20%3D%20list.length%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Elet%3C%2Fspan%3E%20rootDomain%20%3D%20domain%3B%0A%0A%3Cspan%20class%3D%22hljs-keyword%22%3Ewhile%3C%2Fspan%3E%20(len--)%20%7B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Etry%3C%2Fspan%3E%20%7B%0A%20%20%20%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20list.slice(len).join(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%20%20%20%20rootDomain%20%3D%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%3B%0A%20%20%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Ebreak%3C%2Fspan%3E%3B%0A%20%20%7D%20%3Cspan%20class%3D%22hljs-keyword%22%3Ecatch%3C%2Fspan%3E%20(e)%20%7B%7D%0A%7D%0A%0A%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20%E8%BF%98%E5%BE%97%E6%81%A2%E5%A4%8D%E5%8E%9F%E5%80%BC%EF%BC%8C%E9%81%BF%E5%85%8D%E4%BA%A7%E7%94%9F%E5%89%AF%E4%BD%9C%E7%94%A8%3C%2Fspan%3E%0A%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20domain%3B%0A%0A%3Cspan%20class%3D%22hljs-built_in%22%3Econsole%3C%2Fspan%3E.log(rootDomain)%3B&lt;/code&gt;</textarea><p>很好，经过简单测试，Chrome、IE 妥妥的。</p><p>然而 Firefox 挂了。挂在最后的还原阶段。也就是说，Firefox 允许修改 <textarea width="0" height="0" class="codespan" style="display:none;">document.domain</textarea>，但不允许修改成上一级之后，再回退到下一级。</p><p>此外（感谢老大），在 Safari 上测试发现，<textarea width="0" height="0" class="codespan" style="display:none;">document.domain = 'cn'</textarea> 不会报错！什么鬼？请移步<a href="https://imququ.com/post/document-domain-bug-in-webkit.html" target="_blank">《Webkit下最无敌的跨大域方案》</a>。</p><p>功亏一篑。心好累啊。</p><h2 id="cookie-">Cookie 救火</h2><p>最后想起前面提到的一句，“想在一个叫 edu.cn 的域下存 cookie？对不起，浏览器做不到。”</p><p>要不咱试试 cookie？动手！</p><p>道理同上，每次尝试在手动拼接的 domain 下面存 cookie，然后检查 cookie 是否保存成功。一旦成功，则 break 循环，并清除该 cookie。没有副作用，只是多操作几次 cookie。</p><p>换个思路，总算是解决了。</p><p>代码被我放在了 <a href="https://github.com/AngusFu/browser-root-domain" target="_blank">Github</a> 上。顺手贴在这里：</p><textarea width="0" height="0" class="pre-area" style="display:none;">&lt;code class=&quot;hljs lang-javascript&quot;&gt;%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20KEY%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E'__rT_dM__'%3C%2Fspan%3E%20%2B%20(%2B%3Cspan%20class%3D%22hljs-keyword%22%3Enew%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-built_in%22%3EDate%3C%2Fspan%3E())%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20R%20%3D%20%3Cspan%20class%3D%22hljs-keyword%22%3Enew%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-built_in%22%3ERegExp%3C%2Fspan%3E(%3Cspan%20class%3D%22hljs-string%22%3E'(%5E%7C%3B)%5C%5Cs*'%3C%2Fspan%3E%20%2B%20KEY%20%2B%20%3Cspan%20class%3D%22hljs-string%22%3E'%3D1'%3C%2Fspan%3E)%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20Y1970%20%3D%20(%3Cspan%20class%3D%22hljs-keyword%22%3Enew%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-built_in%22%3EDate%3C%2Fspan%3E(%3Cspan%20class%3D%22hljs-number%22%3E0%3C%2Fspan%3E)).toUTCString()%3B%0A%0A%3Cspan%20class%3D%22hljs-built_in%22%3Emodule%3C%2Fspan%3E.exports%20%3D%20%3Cspan%20class%3D%22hljs-function%22%3E%3Cspan%20class%3D%22hljs-keyword%22%3Efunction%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-title%22%3EgetRootDomain%3C%2Fspan%3E(%3Cspan%20class%3D%22hljs-params%22%3E%3C%2Fspan%3E)%20%3C%2Fspan%3E%7B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20domain%20%3D%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%7C%7C%20location.hostname%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20list%20%3D%20domain.split(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20len%20%3D%20list.length%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20temp%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E''%3C%2Fspan%3E%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20temp2%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E''%3C%2Fspan%3E%3B%0A%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Ewhile%3C%2Fspan%3E%20(len--)%20%7B%0A%20%20%20%20temp%20%3D%20list.slice(len).join(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%20%20%20%20temp2%20%3D%20KEY%20%2B%20%3Cspan%20class%3D%22hljs-string%22%3E'%3D1%3Bdomain%3D.'%3C%2Fspan%3E%20%2B%20temp%3B%0A%0A%20%20%20%20%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20try%20to%20set%20cookie%3C%2Fspan%3E%0A%20%20%20%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.cookie%20%3D%20temp2%3B%0A%0A%20%20%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E%20(R.test(%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.cookie))%20%7B%0A%20%20%20%20%20%20%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20clear%3C%2Fspan%3E%0A%20%20%20%20%20%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.cookie%20%3D%20temp2%20%2B%20%3Cspan%20class%3D%22hljs-string%22%3E'%3Bexpires%3D'%3C%2Fspan%3E%20%2B%20Y1970%3B%0A%20%20%20%20%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E%20temp%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B&lt;/code&gt;</textarea><h2 id="-20170504">更新@20170504</h2><p>今天在奇舞周刊的评论区看到有同学的评论。看来我遇到的问题，很早就有人遇到过了。
顺着评论看了下，知乎的这个回答非常清晰：<a href="https://www.zhihu.com/question/20994750?sort=created" target="_blank">如何使用正则表达式得到一个 URL 中的主域名</a>。
当初真没想到“主域名”这个词，满脑子都是“根域名”。结果就与这回答失之交臂。当然，如果早点遇到知乎的回答，也就不会有这篇文章了吧。</p></div></article><nav class="pagination"><a href="/post/unicode-javascript-and-the-emoji-family" title="[译] Emoji.prototype.length  —— Unicode 字符那些事儿" class="prev">« [译] Emoji.prototype.length  —— Unicode 字符那些事儿</a><a href="/post/2017-03-12-post" title="周末闲谈" class="next">周末闲谈 »</a></nav><div></div></div><footer id="footer" class="inner">
      © 2018 -  文蔺的博客
      <span> - </span><a href="/" class="nuxt-link-active">www.wemlion.com</a><br>
      Powered by <a target="_blank" href="https://nuxtjs.org">Nuxt.js</a> &amp; <a target="_blank" rel="nofollow" href="https://firekylin.org" class="external">FireKylin</a></footer></div></div></div></div><script type="text/javascript">window.__NUXT__={"layout":"default","data":[{}],"error":null,"serverRendered":true};</script><script src="/static/manifest.4f625a5f.js" defer></script><script src="/static/0-cf2867bf.js" defer></script><script src="/static/60-708a1f60.js" defer></script><script src="/static/common.d774ec7b.js" defer></script><script src="/static/app.ff62209b.js" defer></script>
  </body>
</html>

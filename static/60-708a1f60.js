webpackJsonp([60],{MQm3:function(s,a,t){"use strict";var e=function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("div",{attrs:{id:"page-post"}},[t("article",{staticClass:"post detail"},[t("div",{staticClass:"meta"},[t("div",{staticClass:"date"},[s._v(s._s(s.post.create_time))])]),t("h1",{staticClass:"title"},[s._v(s._s(s.post.title))]),t("div",{staticClass:"entry-content"},[s.post.translation?t("blockquote",[t("p",{staticStyle:{"white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"}},[s._v("\n        原文作者: "),t("a",{attrs:{href:s.post.translation.social,target:"_blank"}},[s._v(s._s(s.post.translation.author))]),t("br"),s._v("\n        原文地址: "),t("a",{attrs:{href:s.post.translation.from}},[s._v(s._s(s.post.translation.from))]),t("br"),s._v("\n        译文地址: "),t("a",{attrs:{href:s.post_url}},[s._v(s._s(s.post_url))]),t("br"),s._v("\n        本文由 "),t("a",{attrs:{href:this.$config.site_url}},[s._v(s._s(this.$config.site_owner))]),s._v(" 翻译，转载请保留此声明。"),t("br"),s._v("\n        著作权属于原作者，本译文仅用于学习、研究和交流目的，请勿用于商业目的。\n        ")])]):s._e(),t("p",[s._v("首先声明，这里所说的“根域名”，并不是指“全球共有13台根逻辑域名服务器”这句话中的“根域名”。而是指某一个站点的“根域名”（更新：或者也可以称之为“当前网站的主域名”，目前笔者并没有找到标准称呼）。")]),t("p",[s._v("百度搜索是“www.baidu.com”，百度翻译的域名是“fanyi.baidu.com”，百度地图的域名则是“map.baidu.com”。这些域名有共同的部分“baidu.com”。在本文中，我们将“baidu.com”这样的域名称为“根域名”。前端同学应该都知道，在“.baidu.com”这一域下的 cookie 可以在其他子站点下拿到（当然，前提是端口号和协议都保持一致）。")]),t("p",[s._v("最近开发的过程中遇上了一个小问题。无论访问哪个子站点，都要通过 js 将 cookie 存放到根域名下。")]),t("p",[s._v("一开始比较大意，直接拿正则匹配。问题是忽略了这世界上还存在“www.xxx.edu.cn”这样的站点。在这种情况下，显然我们不能认为”edu.cn“是根域名。想在一个叫“edu.cn”的域下存 cookie？对不起，浏览器做不到。（这句话很重要。）")]),t("p",[s._v("正则匹配是做不到了。搜索了一下，网上也没有什么特别好的解决方案。无非是枚举出国内常见的一些顶级域名，然后再进行处理，如下面这个 PHP 的例子：")]),t("p",[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:"https://ww2.sinaimg.cn/large/006tNbRwly1ff0e6map85j31000nuq53.jpg",expression:"`https://ww2.sinaimg.cn/large/006tNbRwly1ff0e6map85j31000nuq53.jpg`"}],attrs:{alt:""}})]),t("p",[s._v("但如何确保我们枚举出的例子一定是完全的无遗漏的呢？不完美，放弃。")]),t("h2",{attrs:{id:"psl"}},[s._v("PSL")]),s._m(0),s._m(1),t("p",[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:"https://ww1.sinaimg.cn/large/006tNbRwly1ff0ei3m2wlj31f80ey0us.jpg",expression:"`https://ww1.sinaimg.cn/large/006tNbRwly1ff0ei3m2wlj31f80ey0us.jpg`"}],attrs:{alt:""}})]),t("p",[s._v("我搜索到的这个 psl 仓库正是基于 PSL、使用 js 来解析域名的。粗略看了下，存放域名的 json 文件有 108 KB。吓死了。")]),t("p",[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:"https://ww3.sinaimg.cn/large/006tNbRwly1ff0eipy8z6j31ku0i4abp.jpg",expression:"`https://ww3.sinaimg.cn/large/006tNbRwly1ff0eipy8z6j31ku0i4abp.jpg`"}],attrs:{alt:""}})]),s._m(2),t("p",[t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:"https://ww4.sinaimg.cn/large/006tNbRwly1ff0elsqwolj31ju0jmaco.jpg",expression:"`https://ww4.sinaimg.cn/large/006tNbRwly1ff0elsqwolj31ju0jmaco.jpg`"}],attrs:{alt:""}})]),t("p",[s._v("没办法，一个跑到浏览器上的前端脚本，本身不到 1500 行，为了一个判断引入上百 KB 的外部依赖，实在不划算。")]),t("p",[s._v("于是只能自己另起炉灶，想想别的办法。")]),t("h2",{attrs:{id:"document-domain"}},[s._v("document.domain")]),t("p",[s._v("首先想到的是 "),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("document.domain")]),s._v("。在一些需要跨域的场景中，可能会见到这货的身影。比如"),t("a",{attrs:{href:"http://www.tuicool.com/articles/jmY3Yr6",target:"_blank"}},[s._v("这篇文章")]),s._v(" 所描述的，“相同主域名不同子域名下的页面，可以设置 document.domain 让它们同域”。")]),t("p",[s._v("经过测试发现，对于域名"),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("c.example.edu.cn")]),s._v("下的页面，可以执行下面这句：")]),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"pre-area",attrs:{width:"0",height:"0"}},[s._v("<code class=\"hljs lang-javascript\">%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E'example.edu.cn'%3C%2Fspan%3E%3B</code>")]),t("p",[s._v("而在 Chrome 下，下面这句则无法执行：")]),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"pre-area",attrs:{width:"0",height:"0"}},[s._v("<code class=\"hljs lang-javascript\">%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20DOMException%3C%2Fspan%3E%0A%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E'edu.cn'%3C%2Fspan%3E%3B</code>")]),t("p",[s._v("浏览器会抛出"),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("DOMException")]),s._v("：")]),s._m(3),t("p",[s._v("IE 也会报出“参数无效”的错误；Firefox 下同样会抛出错误：")]),s._m(4),t("p",[s._v("从报错信息可以看到， DOMException 是可以捕获到的。那就好办了。")]),t("p",[s._v("将域名（或页面当前的 "),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("document.domain")]),s._v("） split 成数据 "),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("['x', 'example', 'edu', 'cn']")]),s._v("，从右向左逐次加上一个元素，每次将单词使用句点连接并赋值给 "),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("document.domain")]),s._v("。如果 catch 到错误，则进行下一次操作。一旦赋值成功，即可 break 循环。")]),t("p",[s._v("上代码：")]),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"pre-area",attrs:{width:"0",height:"0"}},[s._v("<code class=\"hljs lang-javascript\">%3Cspan%20class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E%20domain%20%3D%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E%20list%20%3D%20domain.split(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%0A%3Cspan%20class%3D%22hljs-keyword%22%3Elet%3C%2Fspan%3E%20len%20%3D%20list.length%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Elet%3C%2Fspan%3E%20rootDomain%20%3D%20domain%3B%0A%0A%3Cspan%20class%3D%22hljs-keyword%22%3Ewhile%3C%2Fspan%3E%20(len--)%20%7B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Etry%3C%2Fspan%3E%20%7B%0A%20%20%20%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20list.slice(len).join(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%20%20%20%20rootDomain%20%3D%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%3B%0A%20%20%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Ebreak%3C%2Fspan%3E%3B%0A%20%20%7D%20%3Cspan%20class%3D%22hljs-keyword%22%3Ecatch%3C%2Fspan%3E%20(e)%20%7B%7D%0A%7D%0A%0A%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20%E8%BF%98%E5%BE%97%E6%81%A2%E5%A4%8D%E5%8E%9F%E5%80%BC%EF%BC%8C%E9%81%BF%E5%85%8D%E4%BA%A7%E7%94%9F%E5%89%AF%E4%BD%9C%E7%94%A8%3C%2Fspan%3E%0A%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%3D%20domain%3B%0A%0A%3Cspan%20class%3D%22hljs-built_in%22%3Econsole%3C%2Fspan%3E.log(rootDomain)%3B</code>")]),t("p",[s._v("很好，经过简单测试，Chrome、IE 妥妥的。")]),t("p",[s._v("然而 Firefox 挂了。挂在最后的还原阶段。也就是说，Firefox 允许修改 "),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("document.domain")]),s._v("，但不允许修改成上一级之后，再回退到下一级。")]),t("p",[s._v("此外（感谢老大），在 Safari 上测试发现，"),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"codespan",attrs:{width:"0",height:"0"}},[s._v("document.domain = 'cn'")]),s._v(" 不会报错！什么鬼？请移步"),t("a",{attrs:{href:"https://imququ.com/post/document-domain-bug-in-webkit.html",target:"_blank"}},[s._v("《Webkit下最无敌的跨大域方案》")]),s._v("。")]),t("p",[s._v("功亏一篑。心好累啊。")]),t("h2",{attrs:{id:"cookie-"}},[s._v("Cookie 救火")]),t("p",[s._v("最后想起前面提到的一句，“想在一个叫 edu.cn 的域下存 cookie？对不起，浏览器做不到。”")]),t("p",[s._v("要不咱试试 cookie？动手！")]),t("p",[s._v("道理同上，每次尝试在手动拼接的 domain 下面存 cookie，然后检查 cookie 是否保存成功。一旦成功，则 break 循环，并清除该 cookie。没有副作用，只是多操作几次 cookie。")]),t("p",[s._v("换个思路，总算是解决了。")]),s._m(5),t("textarea",{directives:[{name:"show",rawName:"v-show",value:!1,expression:"false"}],staticClass:"pre-area",attrs:{width:"0",height:"0"}},[s._v("<code class=\"hljs lang-javascript\">%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20KEY%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E'__rT_dM__'%3C%2Fspan%3E%20%2B%20(%2B%3Cspan%20class%3D%22hljs-keyword%22%3Enew%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-built_in%22%3EDate%3C%2Fspan%3E())%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20R%20%3D%20%3Cspan%20class%3D%22hljs-keyword%22%3Enew%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-built_in%22%3ERegExp%3C%2Fspan%3E(%3Cspan%20class%3D%22hljs-string%22%3E'(%5E%7C%3B)%5C%5Cs*'%3C%2Fspan%3E%20%2B%20KEY%20%2B%20%3Cspan%20class%3D%22hljs-string%22%3E'%3D1'%3C%2Fspan%3E)%3B%0A%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20Y1970%20%3D%20(%3Cspan%20class%3D%22hljs-keyword%22%3Enew%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-built_in%22%3EDate%3C%2Fspan%3E(%3Cspan%20class%3D%22hljs-number%22%3E0%3C%2Fspan%3E)).toUTCString()%3B%0A%0A%3Cspan%20class%3D%22hljs-built_in%22%3Emodule%3C%2Fspan%3E.exports%20%3D%20%3Cspan%20class%3D%22hljs-function%22%3E%3Cspan%20class%3D%22hljs-keyword%22%3Efunction%3C%2Fspan%3E%20%3Cspan%20class%3D%22hljs-title%22%3EgetRootDomain%3C%2Fspan%3E(%3Cspan%20class%3D%22hljs-params%22%3E%3C%2Fspan%3E)%20%3C%2Fspan%3E%7B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20domain%20%3D%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.domain%20%7C%7C%20location.hostname%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20list%20%3D%20domain.split(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20len%20%3D%20list.length%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20temp%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E''%3C%2Fspan%3E%3B%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Evar%3C%2Fspan%3E%20temp2%20%3D%20%3Cspan%20class%3D%22hljs-string%22%3E''%3C%2Fspan%3E%3B%0A%0A%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Ewhile%3C%2Fspan%3E%20(len--)%20%7B%0A%20%20%20%20temp%20%3D%20list.slice(len).join(%3Cspan%20class%3D%22hljs-string%22%3E'.'%3C%2Fspan%3E)%3B%0A%20%20%20%20temp2%20%3D%20KEY%20%2B%20%3Cspan%20class%3D%22hljs-string%22%3E'%3D1%3Bdomain%3D.'%3C%2Fspan%3E%20%2B%20temp%3B%0A%0A%20%20%20%20%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20try%20to%20set%20cookie%3C%2Fspan%3E%0A%20%20%20%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.cookie%20%3D%20temp2%3B%0A%0A%20%20%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E%20(R.test(%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.cookie))%20%7B%0A%20%20%20%20%20%20%3Cspan%20class%3D%22hljs-comment%22%3E%2F%2F%20clear%3C%2Fspan%3E%0A%20%20%20%20%20%20%3Cspan%20class%3D%22hljs-built_in%22%3Edocument%3C%2Fspan%3E.cookie%20%3D%20temp2%20%2B%20%3Cspan%20class%3D%22hljs-string%22%3E'%3Bexpires%3D'%3C%2Fspan%3E%20%2B%20Y1970%3B%0A%20%20%20%20%20%20%3Cspan%20class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E%20temp%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%7D%3B</code>")]),t("h2",{attrs:{id:"-20170504"}},[s._v("更新@20170504")]),s._m(6)])]),s.post.prev.title||s.post.next.title?t("nav",{staticClass:"pagination"},[s.post.prev.title?t("nuxt-link",{staticClass:"prev",attrs:{to:"/post/"+s.post.prev.pathname,title:s.post.prev.title}},[s._v("« "+s._s(s.post.prev.title))]):s._e(),s.post.next.title?t("nuxt-link",{staticClass:"next",attrs:{to:"/post/"+s.post.next.pathname,title:s.post.next.title}},[s._v(s._s(s.post.next.title)+" »")]):s._e()],1):s._e(),t("gitalk",{attrs:{tags:s.tags}})],1)};e._withStripped=!0;var n={render:e,staticRenderFns:[function(){var s=this.$createElement,a=this._self._c||s;return a("p",[this._v("接着上 github 上去找例子。倒是发现了一些解决域名的工具。比如一个名为 "),a("a",{attrs:{href:"https://github.com/wrangr/psl",target:"_blank"}},[this._v("psl")]),this._v(" 的仓库。")])},function(){var s=this.$createElement,a=this._self._c||s;return a("p",[a("a",{attrs:{href:"http://publicsuffix.org/",target:"_blank"}},[this._v("PSL")]),this._v(" 是 “Public Suffix List” 的缩写，这个“公共域名后缀列表”项目本来是供浏览器厂商使用的。可以访问"),a("a",{attrs:{href:"https://publicsuffix.org/",target:"_blank"}},[this._v("官网")]),this._v("，另外建议看看这篇"),a("a",{attrs:{href:"https://imququ.com/post/domain-public-suffix-list.html",target:"_blank"}},[this._v("《域名小知识：Public Suffix List》")]),this._v("。")])},function(){var s=this.$createElement,a=this._self._c||s;return a("p",[this._v("另一款叫做 "),a("a",{attrs:{href:"https://github.com/peerigon/parse-domain/",target:"_blank"}},[this._v("parse-domain")]),this._v(" 的，光是生成的正则表达式文件就有 203 KB。")])},function(){var s=this.$createElement,a=this._self._c||s;return a("blockquote",[a("p",[this._v("1 Uncaught DOMException: Failed to set the 'domain' property on 'Document': 'edu.cn' is not a suffix of 'c.example.edu.cn'.")])])},function(){var s=this.$createElement,a=this._self._c||s;return a("blockquote",[a("p",[this._v("NS_ERROR_DOM_BAD_DOCUMENT_DOMAIN: Illegal document.domain value")])])},function(){var s=this.$createElement,a=this._self._c||s;return a("p",[this._v("代码被我放在了 "),a("a",{attrs:{href:"https://github.com/AngusFu/browser-root-domain",target:"_blank"}},[this._v("Github")]),this._v(" 上。顺手贴在这里：")])},function(){var s=this.$createElement,a=this._self._c||s;return a("p",[this._v("今天在奇舞周刊的评论区看到有同学的评论。看来我遇到的问题，很早就有人遇到过了。\n顺着评论看了下，知乎的这个回答非常清晰："),a("a",{attrs:{href:"https://www.zhihu.com/question/20994750?sort=created",target:"_blank"}},[this._v("如何使用正则表达式得到一个 URL 中的主域名")]),this._v("。\n当初真没想到“主域名”这个词，满脑子都是“根域名”。结果就与这回答失之交臂。当然，如果早点遇到知乎的回答，也就不会有这篇文章了吧。")])}]};a.a=n},uabq:function(s,a,t){"use strict";var e={title:"笔记：如何获取网站根域名",description:"笔记：如何获取网站根域名",keywords:"JavaScript,开发心得,原创",pathname:"get-root-domain-of-a-site",translation:null,create_time:"2017-04-26",prev:{title:"[译] Emoji.prototype.length  —— Unicode 字符那些事儿",pathname:"unicode-javascript-and-the-emoji-family"},next:{title:"周末闲谈",pathname:"2017-03-12-post"}};a.a={head:function(){return{title:e.title,meta:[{name:"keywords",content:e.keywords||""},{name:"description",content:e.description}]}},data:function(){return{post:e,post_url:this.$config.site_url+"/post/"+e.pathname,tags:e.tags}},mounted:function(){this.$fixCode()}}},x3Ra:function(s,a,t){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var e=t("uabq"),n=t("MQm3"),i=t("VU/8")(e.a,n.a,!1,null,null,null);i.options.__file="pages/post/get-root-domain-of-a-site.vue",a.default=i.exports}});